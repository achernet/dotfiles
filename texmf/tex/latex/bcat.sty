\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{bcat}[2011/12/17 Jonathan Rascher's preamble]

% Load e-TeX and KOMA-script helper commands.
\RequirePackage{etoolbox,scrlfile}

% Load math packages.
\RequirePackage{mathtools,thmtools,centernot}

% Save the thmtools version of `\@xa` so we can restore it later. (This is
% needed to prevent conflicts with tkz-base.
\let\@bcat@oldxa\@xa
\AfterPackage*{tkz-base}{
  \let\@xa\@bcat@oldxa
  \AfterEndEnvironment{tikzpicture}{
    \global\let\@xa\@bcat@oldxa}}

% Set up theorem-like environments.
\declaretheoremstyle[notefont=,notebraces={}{}]{exer*}

\declaretheorem[
  name=Theorem]{thm}
\declaretheorem[
  sibling=thm,
  name=Proposition]{prop}
\declaretheorem[
  sibling=thm,
  name=Lemma]{lem}
\declaretheorem[
  sibling=thm,
  name=Corollary]{cor}

\declaretheorem[
  sibling=thm,
  name=Definition,
  style=definition]{defn}
\declaretheorem[
  sibling=thm,
  name=Example,
  style=definition]{xmp}

\declaretheorem[
  sibling=thm,
  name=Exercise,
  style=definition]{exer}
\declaretheorem[
  numbered=no,
  name=Exercise,
  style=exer*]{exer*}
\declaretheorem[
  numbered=no,
  name=\!\!,
  style=exer*]{exer**}

% Load graphics packages.
\RequirePackage[dvipsnames,usenames]{color}

% Load miscellaneous packages.
\RequirePackage{floatrow,fixltx2e,marginfix,multicol}
\floatsetup[table]{style=plaintop}

% Configure PDF links and metadata.
\RequirePackage[pdfusetitle]{hyperref}
\hypersetup{
  colorlinks,
  linkcolor=RawSienna,
  citecolor=RawSienna,
  urlcolor=RawSienna,
  pdfpagemode=UseNone,
  pdfstartview=FitH,
  pdfprintscaling=None}

% Load packages that must come after hyperref.
\RequirePackage{ellipsis}

% Make sure touchy packages are loaded LAST!
\AtEndPreamble{
  % Load cleveref for fancy references.
  \RequirePackage{cleveref}

  \crefname{thm}{Theorem}{Theorems}
  \crefname{prop}{Proposition}{Propositions}
  \crefname{lem}{Lemma}{Lemmas}
  \crefname{defn}{Definition}{Definitions}
  \crefname{xmp}{Example}{Examples}
  \crefname{exer}{Exercise}{Exercises}
  \crefname{exer*}{Exercise}{Exercises}}

% Prefer variant forms of epsilon and phi.
\let\@bcat@oldepsilon\epsilon
\let\@bcat@oldphi\phi

\let\epsilon\varepsilon
\let\phi\varphi

\let\varepsilon\@bcat@oldepsilon
\let\varphi\@bcat@oldphi

% Patch up `\left` and `\right` to fix spacing.
% Source: <http://tex.stackexchange.com/questions/2607/#2610>.
\let\@bcat@oldleft\left
\let\@bcat@oldright\right

\renewcommand*\left{\mathopen{}\mathclose\bgroup\@bcat@oldleft}
\renewcommand*\right{\aftergroup\egroup\@bcat@oldright}

% Define useful shorthand commands.
\newcommand*\padic{$p$\nbds adic}

\newcommand*\C{\mathbb C}
\newcommand*\N{\mathbb N}
\newcommand*\Q{\mathbb Q}
\newcommand*\R{\mathbb R}
\newcommand*\Z{\mathbb Z}

\newcommand*\bb[1]{\mathbb{#1}}
\newcommand*\mc[1]{\mathcal{#1}}
\newcommand*\mf[1]{\mathfrak{#1}}
\newcommand*\mi[1]{\mathit{#1}}
\newcommand*\mr[1]{\mathrm{#1}}
\newcommand*\ms[1]{\mathscr{#1}}
\newcommand*\vr[1]{\mathbf{#1}}

% Define commands for use in lecture/study notes.
\newcommand*\dfn[1]{\emph{#1}}

% Define commands for custom math functions.
\DeclareMathOperator\Comp{Comp}
\DeclareMathOperator\Tr{Tr}
\DeclareMathOperator\adj{adj}
\DeclareMathOperator\chr{chr}
\DeclareMathOperator\lcm{lcm}
\DeclareMathOperator\nullity{nullity}
\DeclareMathOperator\range{range}
\DeclareMathOperator\rank{rank}
\DeclareMathOperator\spans{span}

% Define commands for custom math operators and relations.
\ifundef\divides{\newcommand*\divides{\mid}}{}
\ifundef\ndivides{\newcommand*\ndivides{\centernot\divides}}{}

% Define commands for custom math delimiter structures.
\DeclarePairedDelimiter\abs{\lvert}{\rvert}
\DeclarePairedDelimiter\norm{\lVert}{\rVert}

% Define commands for typographical tweaks.
\newcommand*\nbds[1][-]{\nobreakdashes#1\hspace{0pt}}
\newcommand*\nextline{\leavevmode\@afterheading}

% Extend amsmath to support augmented matrices.
% Source: <http://texblog.net/latex-archive/maths/amsmath-matrix/>.
\renewcommand*\env@matrix[1][*\c@MaxMatrixCols c]{%
  \hskip -\arraycolsep
  \let\@ifnextchar\new@ifnextchar
  \array{#1}}
